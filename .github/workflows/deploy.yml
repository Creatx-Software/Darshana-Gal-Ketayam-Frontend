name: Build and Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering from GitHub UI

env:
  NODE_VERSION: '20.x'
  NEXT_PUBLIC_API_URL: https://api.darshanagalketayam.lk
  NEXT_PUBLIC_SITE_URL: https://darshanagalketayam.lk
  NODE_ENV: production

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Install dependencies with clean install for reproducible builds
      - name: Install dependencies
        run: |
          # Update lock file if out of sync, then clean install
          npm install --package-lock-only
          npm ci --include=dev

      # Run type checking
      - name: Type check
        run: npm run type-check
        continue-on-error: false

      # Build the Next.js application (this will catch most code issues)
      - name: Build Next.js application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ env.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_SITE_URL: ${{ env.NEXT_PUBLIC_SITE_URL }}
          NODE_ENV: ${{ env.NODE_ENV }}

      # Create .env.production file
      - name: Create environment file
        run: |
          echo "NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }}" > .env.production
          echo "NEXT_PUBLIC_SITE_URL=${{ env.NEXT_PUBLIC_SITE_URL }}" >> .env.production
          echo "NODE_ENV=production" >> .env.production

          echo "üì¶ Deployment package ready"
          echo "Package size breakdown:"
          du -sh .next public

      # Deploy .next folder
      - name: Deploy .next build folder
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local_path: './.next/'
          remote_path: '/var/www/vhosts/darshanagalketayam.lk/httpdocs/.next'
          sftp_only: true
          delete_remote_files: false
          args: '-o ConnectTimeout=5'

      # Deploy public folder
      - name: Deploy public folder
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local_path: './public/'
          remote_path: '/var/www/vhosts/darshanagalketayam.lk/httpdocs/public'
          sftp_only: true
          delete_remote_files: false
          args: '-o ConnectTimeout=5'

      # Deploy config files
      - name: Deploy configuration files
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local_path: './package.json ./package-lock.json ./next.config.js ./.env.production'
          remote_path: '/var/www/vhosts/darshanagalketayam.lk/httpdocs'
          sftp_only: true
          delete_remote_files: false
          args: '-o ConnectTimeout=5'

      # Install dependencies on server and restart
      - name: Install dependencies and restart on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          script: |
            cd /var/www/vhosts/darshanagalketayam.lk/httpdocs
            echo "üì¶ Installing production dependencies..."
            npm ci --production --prefer-offline
            echo "üîÑ Restarting PM2 process..."
            pm2 restart darshana-gal-ketayam || pm2 start npx --name "darshana-gal-ketayam" -- next start
            pm2 save
            echo "‚úÖ Application restarted successfully!"

      # Verify deployment
      - name: Verify deployment
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Site URL: ${{ env.NEXT_PUBLIC_SITE_URL }}"
          echo "üì¶ Deployed .next build and config files"
          echo "üîÑ Dependencies installed and PM2 restarted on server"

      # Notify on failure
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Please check the logs above."
          exit 1
